{% extends "base.html" %}

{% block script %}
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
    var socket = io('/game');
    var in_game = false;

    socket.on('connect', function() {
        socket.emit('join', {hashed_game_id: '{{ hashed_game_id }}'});
    });

    socket.on('update_players', function(data) {
        if(in_game){
            return
        }
        var playersList = document.getElementById('players');
        if (data.players.length > 0) {
            playersList.innerHTML = '';
            data.players.forEach(function(player) {
            var li = document.createElement('li');
            li.appendChild(document.createTextNode(player.name));
            li.className = 'list-group-item';
            playersList.appendChild(li);
        });
    } else {
        playersList.innerHTML = 'No players yet.';
    }
    });


    socket.on('update_settings', function(data) {
        if(in_game){
            return
        }
        if (data.settings) {
            document.getElementById('starting_card_amount').value = data.settings.starting_card_amount;
            document.getElementById('black_card_finish').checked = data.settings.black_card_finish === true;
            document.getElementById('black_on_black').checked = data.settings.black_on_black === true;
            document.getElementById('plus_two_stacking').checked = data.settings.plus_two_stacking === true;
        }
    });

    socket.on('start_game', function(data) {
        if(in_game){
            return
        }
        if (!data.start) {
            document.getElementById('startGameButton').disabled = false;
            return
        }
        console.log("Game is starting...");
        document.body.innerHTML = '<h1>Game is loading ...</h1>';
        fetch("{{ url_for('sites.game', hashed_game_id=hashed_game_id, _external=True) }}")
        .then(response => response.text())
        .then(html => {
            document.body.innerHTML = html;
            in_game = true;
            socket.emit('request_cards', {hashed_game_id: '{{ hashed_game_id }}'});
        })
        .catch(error => console.error('Error loading the game interface:', error));
    });

    socket.on('kick', function(data) {
        alert(data.message);
        window.location.href = '{{url_for('sites.index')}}';
    });

    function updateSettings() {
        var settingsData = {
            starting_card_amount: document.getElementById('starting_card_amount').value,
            black_card_finish: document.getElementById('black_card_finish').checked,
            black_on_black: document.getElementById('black_on_black').checked,
            plus_two_stacking: document.getElementById('plus_two_stacking').checked
        };
        socket.emit('update_settings', {hashed_game_id: '{{ hashed_game_id }}', settings: settingsData});
    }

    function startGame() {
        socket.emit('start_game', {hashed_game_id: '{{ hashed_game_id }}'});
        document.getElementById('startGameButton').disabled = true;
    }

    //in_game

    socket.on('update_cards', function(data) {
        if (in_game) {
            console.log('Cards data:', data.cards);
            var cardCountsList = document.getElementById('card-counts');
            cardCountsList.innerHTML = '';

            for (var player in data.cards) {
                var cardCountItem = document.createElement('div');
                cardCountItem.className = 'card-count-item';
                var cardCount = data.cards[player].card_count;
                var isCurrentTurn = data.cards[player].is_current_turn;

                cardCountItem.innerHTML = `Player: ${player}, Cards: ${cardCount}`;
                if (isCurrentTurn) {
                    cardCountItem.innerHTML += ' (Current Turn)';
                    cardCountItem.style.fontWeight = 'bold';
                }

                cardCountsList.appendChild(cardCountItem);
            }

            if (data.last_card) {
                var lastCardDiv = document.getElementById('last-card');
                var lastCard = data.last_card;
                lastCardDiv.innerHTML = `ID: ${lastCard.id}, Color: ${lastCard.color}, Value: ${lastCard.value}, Type: ${lastCard.type}`;
            }

            if (data.pull_cards) {
                socket.emit('request_cards', { hashed_game_id: '{{ hashed_game_id }}' });
            }
        }
    });

    socket.on('end_game', function(data) {
        if(in_game){
            return
        }
        if (!data.start) {
            document.getElementById('startGameButton').disabled = false;
            return
        }
        console.log("Game is starting...");
        document.body.innerHTML = '<h1>Game is ending ...</h1>';
        fetch("{{ url_for('sites.lobby', hashed_game_id=hashed_game_id, _external=True) }}")
        .then(response => response.text())
        .then(html => {
            document.body.innerHTML = html;
            in_game = false;
            socket.emit('rejoin', {hashed_game_id: '{{ hashed_game_id }}'});
        })
        .catch(error => console.error('Error loading the game interface:', error));
    });

    socket.on('update_own_cards', function(data) {
        if (in_game) {
            console.log('Move done, cards:', data.cards);
            var cardsList = document.getElementById('cards');
            cardsList.innerHTML = '';
            data.cards.forEach(function(card) {
                var cardItem = document.createElement('div');
                cardItem.className = 'card-item';
                cardItem.innerHTML = `ID: ${card.id}, Color: ${card.color}, Value: ${card.value}, Type: ${card.type}`;
                var playButton = document.createElement('button');
                playButton.innerHTML = 'Play';
                playButton.className = 'play-button btn btn-secondary';

                playButton.addEventListener('click', function() {
                    playCard(card.id, card.color);
                });
                cardItem.appendChild(playButton);
                cardsList.appendChild(cardItem);
            });
        }
    });

    socket.on('uno', (data) => {
        const player = data.player;
        alert(`${player.name} has called UNO!`);
    });

    function playCard(card_id, card_color) {
        if (card_color != 'wild') {
            makeMove('card', card_id)
            return
        }
        document.getElementById('colorSelector').style.display = 'block';
        document.querySelectorAll('.colorButton').forEach(button => {
                button.setAttribute('data-card-id', card_id);
                button.onclick = function() {
                    const selected_color = this.getAttribute('data-color');
                    const card_id = this.getAttribute('data-card-id');
                    console.log('Color selected:', selected_color);
                    document.getElementById('colorSelector').style.display = 'none';
                    makeMove('card', card_id, selected_color);   
                }
            });
    }

    function makeMove(action, card_id = null, selected_color = null) {
        if (in_game) {
            socket.emit('move', {hashed_game_id: '{{ hashed_game_id }}', action: action, card_id: card_id, selected_color: selected_color});
        } else {
            console.log("Cannot make a move. The player is not in a game.");
        }
    }

    function sayUno(action) {
        if (in_game) {
            socket.emit('uno', {hashed_game_id: '{{ hashed_game_id }}'});
        } else {
            console.log("Cannot make a move. The player is not in a game.");
        }
    }

    </script>
    {% block single_page_script %}{% endblock %}
{% endblock %}